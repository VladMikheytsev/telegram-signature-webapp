<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Ввод данных по штрихкоду</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="telegram:webapp" content="true">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: #f4f4f4;
      text-align: center;
      color: #333;
    }
    h2 {
      margin-top: 20px;
      font-size: 24px;
    }
    /* #reader больше не нужен, так как используется нативный сканер Telegram */
    /* #loading также не нужен, так как Telegram управляет UI сканера */

    .error {
      color: red;
      margin: 10px;
    }
    .main-controls {
        margin-top: 20px;
    }
    .main-controls button {
        padding: 15px 30px;
        font-size: 20px;
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
    }
    .step-section {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
        max-width: 400px;
        margin: 20px auto;
        text-align: left;
    }
    .step-section label {
        display: block;
        margin-top: 10px;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .step-section input[type="text"],
    .step-section input[type="number"] {
        width: calc(100% - 22px);
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
    }
    .step-section button {
        width: 100%;
        padding: 12px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 18px;
        cursor: pointer;
    }
    .step-section button:hover {
        background-color: #218838;
    }
    .message {
        margin: 10px;
        padding: 10px;
        border-radius: 5px;
        font-size: 1.1em;
    }
    .message.success {
        background-color: #d4edda;
        color: #155724;
    }
    .message.info {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    .message.warning {
        background-color: #fff3cd;
        color: #856404;
    }
    .message.error {
        background-color: #f8d7da;
        color: #721c24;
    }
  </style>
</head>
<body>
  <h2 aria-live="polite">Система учета товаров</h2>
  <div class="main-controls">
      <button id="startInputButton">Внести данные</button>
  </div>

  <div id="name-input-section" class="step-section" style="display: none;">
    <p><strong>Отсканированный штрихкод:</strong> <span id="scannedBarcodeDisplay"></span></p>
    <label for="productNameInput">Наименование товара:</label>
    <input type="text" id="productNameInput" placeholder="Введите наименование">
    <button id="saveNameButton">ОК</button>
  </div>

  <div id="quantity-input-section" class="step-section" style="display: none;">
    <p><strong>Наименование:</strong> <span id="productNameDisplay"></span></p>
    <label for="quantityInput">Количество:</label>
    <input type="number" id="quantityInput" min="0" value="1">
    <button id="saveQuantityButton">ОК</button>
  </div>

  <div id="warehouse-input-section" class="step-section" style="display: none;">
    <p><strong>Количество:</strong> <span id="quantityDisplay"></span></p>
    <label for="warehouseInput">Склад:</label>
    <input type="text" id="warehouseInput" placeholder="Введите название склада">
    <button id="saveWarehouseButton">ОК</button>
  </div>

  <div id="message-display" class="message" style="display: none;"></div>

  <script>
    const API_BASE_URL = window.location.origin;

    function log(message, level = "info") {
      if (location.hostname === "localhost" || location.hostname.includes("vercel.app") || location.hostname.includes("ngrok.io")) {
        console[level](`[${new Date().toLocaleString()}] ${message}`);
      }
    }

    function validateBarcode(barcode) {
          // Проверяем на EAN-8 (8 цифр) или EAN-13 (13 цифр)
      const regexEAN8 = /^\d{8}$/;
      const regexEAN13 = /^\d{13}$/;
              
      if (regexEAN8.test(barcode) || regexEAN13.test(barcode)) {
        return barcode;
      }
      return null;
    }

    const tg = window.Telegram?.WebApp;
    if (!tg) {
      log("Telegram WebApp not available", "error");
      document.body.innerHTML = `
        <p class="error">Это приложение работает только в Telegram.</p>
        <p>Откройте бота и нажмите кнопку "Внести данные".</p>
        <a href="https://t.me/YourBotName" target="_blank">Открыть бота</a>
      `;
      throw new Error("Telegram WebApp not available");
    }

    log("Telegram WebApp initialized successfully", "info");
    tg.expand();

    const i18n = {
      ru: {
        title: "Система учета товаров",
        inputData: "Внести данные",
        scanBarcode: "Сканируйте штрихкод",
        errorInvalidBarcode: "Ошибка: штрихкод должен состоять из 8 цифр.",
        cameraError: "Не удалось запустить сканер: ", // Эта ошибка менее вероятна с нативным сканером
        permissionError: "Разрешите доступ к камере в настройках устройства.", // Также менее вероятно
        loadingCamera: "Ожидание сканирования Telegram...", // Изменено
        scanning: "Ожидание сканирования...", // Изменено
        barcodeScanned: "Штрихкод отсканирован:",
        enterName: "Введите наименование:",
        enterQuantity: "Введите количество:",
        enterWarehouse: "Введите название склада:",
        buttonOk: "ОК",
        successSaveBarcode: "Штрихкод успешно сохранен!",
        successSaveName: "Наименование успешно сохранено!",
        successSaveQuantity: "Количество успешно сохранено!",
        successSaveWarehouse: "Склад успешно сохранен!",
        errorSave: "Ошибка при сохранении данных.",
        serverError: "Ошибка связи с сервером.",
        allDataSaved: "Все данные успешно внесены!",
        restarting: "Перезапуск для нового ввода..."
      }
    };
    const lang = tg.initDataUnsafe?.user?.language_code || "ru";

    // UI Elements
    const mainTitle = document.querySelector("h2");
    const startInputButton = document.getElementById("startInputButton");
    // const scannerSection = document.getElementById("scanner-section"); // Больше не нужен
    // const scannerTitle = document.getElementById("scanner-title"); // Больше не нужен
    // const readerDiv = document.getElementById("reader"); // Больше не нужен
    // const loadingDiv = document.getElementById("loading"); // Больше не нужен

    const nameInputSection = document.getElementById("name-input-section");
    const scannedBarcodeDisplay = document.getElementById("scannedBarcodeDisplay");
    const productNameInput = document.getElementById("productNameInput");
    const saveNameButton = document.getElementById("saveNameButton");

    const quantityInputSection = document.getElementById("quantity-input-section");
    const productNameDisplay = document.getElementById("productNameDisplay");
    const quantityInput = document.getElementById("quantityInput");
    const saveQuantityButton = document.getElementById("saveQuantityButton");

    const warehouseInputSection = document.getElementById("warehouse-input-section");
    const quantityDisplay = document.getElementById("quantityDisplay");
    const warehouseInput = document.getElementById("warehouseInput");
    const saveWarehouseButton = document.getElementById("saveWarehouseButton");

    const messageDisplay = document.getElementById("message-display");

    let currentBarcode = null;
    let currentRowIndex = null; // Индекс строки, куда будем записывать данные

    // --- Helper Functions ---
    function showMessage(msg, type = "info") {
        messageDisplay.className = `message ${type}`;
        messageDisplay.textContent = msg;
        messageDisplay.style.display = "block";
    }

    function hideMessage() {
        messageDisplay.style.display = "none";
    }

    function resetUI() {
        mainTitle.textContent = i18n[lang].title;
        startInputButton.style.display = 'block';
        // scannerSection.style.display = 'none'; // Больше не нужен
        nameInputSection.style.display = 'none';
        quantityInputSection.style.display = 'none';
        warehouseInputSection.style.display = 'none';
        hideMessage();
        productNameInput.value = '';
        quantityInput.value = '1';
        warehouseInput.value = '';
        currentBarcode = null;
        currentRowIndex = null;
    }

    // --- Step 1: Start Scanning using Telegram's QR/Barcode scanner ---
    startInputButton.addEventListener('click', () => {
        startInputButton.style.display = 'none';
        mainTitle.textContent = i18n[lang].scanning;
        showMessage(i18n[lang].loadingCamera, "info"); // Показываем, что ждем сканера Telegram

        // Показываем нативный сканер QR/штрихкодов Telegram
        tg.showScanQrPopup({ text: "Отсканируйте штрихкод товара." });
    });

    // Обработчик события, когда Telegram возвращает результат сканирования
    tg.onEvent('qrTextReceived', async (data) => {
        const decodedText = data.text;
        log("Decoded barcode from Telegram: " + decodedText, "info");

        // Закрываем сканер Telegram после получения результата
        tg.closeScanQrPopup();

        const barcode = validateBarcode(decodedText);
        if (barcode) {
            currentBarcode = barcode;
            showMessage(`${i18n[lang].barcodeScanned} ${barcode}`, "success");
            await sendBarcodeToBackend(barcode); // Отправляем штрихкод на бэкенд
        } else {
            showMessage(i18n[lang].errorInvalidBarcode, "error");
            // Даем время прочитать сообщение, потом сброс
            setTimeout(() => {
                resetUI(); // Сброс UI и ожидание нового нажатия "Внести данные"
            }, 2000);
        }
    });

    // Обработчик, если пользователь отменил сканирование
    tg.onEvent('scanQrPopupClosed', () => {
        log("Telegram QR Scan Popup closed by user.", "info");
        // Если пользователь закрыл сканер, возвращаемся в начальное состояние
        showMessage("Сканирование отменено.", "info");
        setTimeout(resetUI, 1500);
    });


    // --- Send Barcode to Backend (and get row index) ---
    async function sendBarcodeToBackend(barcode) {
        hideMessage();
        showMessage(i18n[lang].loadingCamera, "info"); // Индикация загрузки
        try {
            const response = await fetch(`${API_BASE_URL}/add-barcode`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ barcode: barcode }),
            });

            const data = await response.json();
            hideMessage();

            if (data.success) {
                currentRowIndex = data.rowIndex; // Сохраняем индекс строки для последующих обновлений
                showMessage(i18n[lang].successSaveBarcode, "success");
                scannedBarcodeDisplay.textContent = barcode;
                setTimeout(() => {
                    nameInputSection.style.display = 'block'; // Показываем ввод наименования
                    mainTitle.textContent = i18n[lang].enterName;
                    hideMessage();
                }, 1000);
            } else {
                showMessage(data.message || i18n[lang].errorSave, "error");
                setTimeout(resetUI, 3000);
            }
        } catch (error) {
            log('Ошибка при отправке штрихкода на сервер:', error, "error");
            showMessage(i18n[lang].serverError, "error");
            setTimeout(resetUI, 3000);
        }
    }

    // --- Step 2: Input Name ---
    saveNameButton.addEventListener('click', async () => {
        const productName = productNameInput.value.trim();
        if (!productName) {
            showMessage("Пожалуйста, введите наименование.", "warning");
            return;
        }

        hideMessage();
        showMessage(i18n[lang].loadingCamera, "info");

        try {
            const response = await fetch(`${API_BASE_URL}/add-name`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ rowIndex: currentRowIndex, productName: productName }),
            });

            const data = await response.json();
            hideMessage();

            if (data.success) {
                showMessage(i18n[lang].successSaveName, "success");
                productNameDisplay.textContent = productName;
                nameInputSection.style.display = 'none'; // Скрываем ввод наименования
                setTimeout(() => {
                    quantityInputSection.style.display = 'block'; // Показываем ввод количества
                    mainTitle.textContent = i18n[lang].enterQuantity;
                    hideMessage();
                }, 1000);
            } else {
                showMessage(data.message || i18n[lang].errorSave, "error");
                setTimeout(resetUI, 3000);
            }
        } catch (error) {
            log('Ошибка при отправке наименования на сервер:', error, "error");
            showMessage(i18n[lang].serverError, "error");
            setTimeout(resetUI, 3000);
        }
    });

    // --- Step 3: Input Quantity ---
    saveQuantityButton.addEventListener('click', async () => {
        const quantity = quantityInput.value;
        if (quantity === '' || isNaN(quantity) || parseInt(quantity) < 0) {
            showMessage("Пожалуйста, введите корректное количество.", "warning");
            return;
        }

        hideMessage();
        showMessage(i18n[lang].loadingCamera, "info");

        try {
            const response = await fetch(`${API_BASE_URL}/add-quantity`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ rowIndex: currentRowIndex, quantity: parseInt(quantity) }),
            });

            const data = await response.json();
            hideMessage();

            if (data.success) {
                showMessage(i18n[lang].successSaveQuantity, "success");
                quantityDisplay.textContent = quantity;
                quantityInputSection.style.display = 'none'; // Скрываем ввод количества
                setTimeout(() => {
                    warehouseInputSection.style.display = 'block'; // Показываем ввод склада
                    mainTitle.textContent = i18n[lang].enterWarehouse;
                    hideMessage();
                }, 1000);
            } else {
                showMessage(data.message || i18n[lang].errorSave, "error");
                setTimeout(resetUI, 3000);
            }
        } catch (error) {
            log('Ошибка при отправке количества на сервер:', error, "error");
            showMessage(i18n[lang].serverError, "error");
            setTimeout(resetUI, 3000);
        }
    });

    // --- Step 4: Input Warehouse ---
    saveWarehouseButton.addEventListener('click', async () => {
        const warehouse = warehouseInput.value.trim();
        if (!warehouse) {
            showMessage("Пожалуйста, введите название склада.", "warning");
            return;
        }

        hideMessage();
        showMessage(i18n[lang].loadingCamera, "info");

        try {
            const response = await fetch(`${API_BASE_URL}/add-warehouse`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ rowIndex: currentRowIndex, warehouse: warehouse }),
            });

            const data = await response.json();
            hideMessage();

            if (data.success) {
                showMessage(i18n[lang].successSaveWarehouse, "success");
                warehouseInputSection.style.display = 'none'; // Скрываем ввод склада
                mainTitle.textContent = i18n[lang].allDataSaved;
                // Все данные внесены, сброс UI для нового цикла
                setTimeout(() => {
                    showMessage(i18n[lang].restarting, "info");
                    setTimeout(resetUI, 1500); // Полный сброс через некоторое время
                }, 1000);

            } else {
                showMessage(data.message || i18n[lang].errorSave, "error");
                setTimeout(resetUI, 3000);
            }
        } catch (error) {
            log('Ошибка при отправке склада на сервер:', error, "error");
            showMessage(i18n[lang].serverError, "error");
            setTimeout(resetUI, 3000);
        }
    });

    // Initial UI state
    resetUI();
  </script>
</body>
</html>
